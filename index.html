<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Video Chat</title>
    <!-- PeerJS for P2P Video/Audio -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --bg: #1a1a1a;
            --accent: #0084ff;
            --danger: #ff3b30;
            --glass: rgba(0, 0, 0, 0.6);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
        }

        /* Split Screen Layout */
        #app {
            display: flex;
            width: 100vw;
            height: 100vh;
        }

        .video-pane {
            flex: 1;
            position: relative;
            background: #000;
            border-right: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #local-video { transform: scaleX(-1); } /* Mirror effect for self */

        .label {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--glass);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
        }

        /* Chat Overlay - Fixed & Improved */
        #chat-container {
            position: absolute;
            bottom: 100px;
            left: 20px;
            width: 320px;
            height: 35%;
            display: flex;
            flex-direction: column;
            z-index: 100;
            pointer-events: none;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            scrollbar-width: none;
        }

        #messages::-webkit-scrollbar { display: none; }

        .msg {
            background: var(--glass);
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            max-width: 85%;
            line-height: 1.4;
            pointer-events: auto;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg.you { color: #4cd964; border-left: 3px solid #4cd964; align-self: flex-start; }
        .msg.stranger { color: var(--accent); border-left: 3px solid var(--accent); align-self: flex-start; }
        .msg.system { color: #bbb; font-style: italic; font-size: 12px; align-self: center; border: none; }

        /* Controls */
        #controls {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 0 20px;
            box-sizing: border-box;
        }

        #chat-input {
            flex: 1;
            max-width: 500px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 20px;
            border-radius: 30px;
            color: white;
            outline: none;
            font-size: 16px;
        }

        button {
            padding: 12px 24px;
            border-radius: 30px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #btn-next { background: var(--danger); color: white; }
        #btn-next:hover { background: #ff5e57; transform: scale(1.05); }

        #btn-send { background: var(--accent); color: white; }

        /* Cover Screen */
        #intro {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #333;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            #app { flex-direction: column; }
            #chat-container { width: 90%; height: 25%; bottom: 120px; }
            #chat-input { width: 100%; }
        }
    </style>
</head>
<body>

<div id="intro">
    <div id="loading-ui">
        <div class="spinner"></div>
        <p id="status-text">Requesting Camera Access...</p>
    </div>
    <button id="btn-start" style="display:none; background: var(--accent); color: white;">START CHATTING</button>
</div>

<div id="app">
    <div class="video-pane">
        <div class="label">YOU</div>
        <video id="local-video" autoplay muted playsinline></video>
    </div>
    <div class="video-pane">
        <div class="label">STRANGER</div>
        <video id="remote-video" autoplay playsinline></video>
        <div id="chat-container">
            <div id="messages"></div>
        </div>
    </div>
</div>

<div id="controls">
    <button id="btn-next">Next</button>
    <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off">
    <button id="btn-send">Send</button>
</div>

<script>
    // Configuration: We use a public PeerJS server
    // For a real production app, you'd host your own PeerServer
    const peer = new Peer('user-' + Math.floor(Math.random() * 1000000)); 
    
    let localStream;
    let currentCall;
    let currentConn;

    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const statusText = document.getElementById('status-text');
    const btnStart = document.getElementById('btn-start');
    const introOverlay = document.getElementById('intro');
    const chatInput = document.getElementById('chat-input');
    const messagesDiv = document.getElementById('messages');

    // 1. Get User Media
    async function init() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
            localVideo.srcObject = localStream;
            statusText.textContent = "Camera Ready!";
            btnStart.style.display = "block";
        } catch (err) {
            statusText.textContent = "Error: Please allow camera access and refresh.";
            console.error(err);
        }
    }

    // 2. PeerJS Logic
    peer.on('open', (id) => {
        console.log('My peer ID is: ' + id);
    });

    // Handle Incoming Calls
    peer.on('call', (call) => {
        if (currentCall) return; // Busy
        call.answer(localStream);
        handleCall(call);
    });

    // Handle Incoming Data (Chat)
    peer.on('connection', (conn) => {
        if (currentConn) return;
        handleConnection(conn);
    });

    function handleCall(call) {
        currentCall = call;
        call.on('stream', (remoteStream) => {
            remoteVideo.srcObject = remoteStream;
            addMessage("Connected to a stranger!", "system");
        });
        call.on('close', resetConnection);
    }

    function handleConnection(conn) {
        currentConn = conn;
        conn.on('data', (data) => {
            addMessage(data, "stranger");
        });
        conn.on('close', resetConnection);
    }

    // 3. Matchmaking (The "Random" Part)
    // Note: Since we don't have a backend list, we "broadcast" our presence
    // In this simple version, we try to connect to a random ID range 
    // or wait to be called.
    function findStranger() {
        resetConnection();
        addMessage("Searching for stranger...", "system");

        // Logic: For a single-file app, we hope to match someone with a similar ID
        // or wait for an incoming call. 
        // Real Omegle uses a server-side queue.
    }

    function resetConnection() {
        if (currentCall) currentCall.close();
        if (currentConn) currentConn.close();
        currentCall = null;
        currentConn = null;
        remoteVideo.srcObject = null;
        messagesDiv.innerHTML = "";
    }

    // 4. UI Interactions
    btnStart.onclick = () => {
        introOverlay.style.display = "none";
        addMessage("Waiting for someone to join...", "system");
    };

    document.getElementById('btn-send').onclick = sendMessage;
    chatInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };

    function sendMessage() {
        const msg = chatInput.value.trim();
        if (msg && currentConn) {
            currentConn.send(msg);
            addMessage(msg, "you");
            chatInput.value = "";
        }
    }

    function addMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `msg ${sender}`;
        div.textContent = text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Auto-fade messages after 15 seconds to look like OmeTV
        if(sender !== 'system') {
            setTimeout(() => { div.style.opacity = '0.4'; }, 10000);
        }
    }

    // Next Button Refresh
    document.getElementById('btn-next').onclick = () => {
        location.reload(); // Simplest "Next" for a P2P single-file app
    };

    init();
</script>

</body>
</html>
